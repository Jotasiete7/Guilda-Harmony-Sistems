<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Harmony SatView</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõ∞Ô∏è</text></svg>">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- GERAL --- */
        body { margin: 0; background: #121212; font-family: 'Inter', sans-serif; overflow: hidden; }
        #map { width: 100vw; height: 100vh; background: #0e0e0e; cursor: crosshair; }

        /* SIDEBAR */
        .sidebar { position: absolute; top: 20px; left: 20px; width: 260px; display: flex; flex-direction: column; gap: 10px; z-index: 1000; max-height: 95vh; }
        
        .glass-box { 
            background: rgba(15, 15, 15, 0.95); backdrop-filter: blur(10px); 
            padding: 12px; border-radius: 8px; color: #e0e0e0; 
            border: 1px solid #333; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        
        .brand-box { text-align: center; border-top: 3px solid #00e676; }
        .brand-title { color: #fff; font-weight: 800; font-size: 18px; margin: 0; letter-spacing: -0.5px; }
        .brand-sub { font-size: 10px; text-transform: uppercase; color: #00e676; letter-spacing: 2px; margin-top: 2px; }

        .credits-box { font-size: 10px; color: #666; text-align: center; padding: 8px; background: rgba(0,0,0,0.8); border-radius: 8px; margin-top: auto; }
        .guild-name { color: #ffc107; font-weight: bold; }
        
        .edit-btn { background: #222; color: #ccc; border: 1px solid #444; padding: 12px; width: 100%; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        .edit-btn:hover { background: #333; color: #fff; }
        .edit-btn.active { background: #00e676; color: #000; border-color: #00e676; box-shadow: 0 0 15px rgba(0, 230, 118, 0.4); }

        /* MODAL */
        #modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #181818; padding: 20px; border-radius: 12px; width: 320px; z-index: 2000; border: 1px solid #444; box-shadow: 0 20px 50px rgba(0,0,0,0.9); }
        .modal-header { font-weight: bold; color: #fff; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; display:flex; justify-content:space-between; align-items:center; }
        .form-group { margin-bottom: 12px; }
        .form-label { display: block; font-size: 11px; color: #888; margin-bottom: 5px; text-transform: uppercase; font-weight: bold; }
        .form-input, .form-select { width: 100%; padding: 10px; background: #252525; border: 1px solid #444; color: #fff; border-radius: 6px; box-sizing: border-box; outline:none; font-size: 13px; }
        .form-input:focus, .form-select:focus { border-color: #00e676; }
        
        .range-wrapper { background: #222; padding: 10px; border-radius: 6px; border: 1px solid #333; }
        .range-slider { width: 100%; cursor: pointer; accent-color: #00e676; height: 5px; }
        .range-value { font-size: 11px; color: #00e676; text-align: right; margin-top: 5px; font-weight: bold; }

        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .btn-save { background: #00e676; color: #000; border: none; padding: 10px; flex: 1; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-save:hover { background: #00c853; }
        .btn-cancel { background: transparent; color: #aaa; border: 1px solid #444; padding: 10px; flex: 0.5; border-radius: 6px; cursor: pointer; }
        .btn-cancel:hover { color: #fff; border-color: #666; }

        /* UI FILTERS */
        .filter-row { display: flex; align-items: center; margin-bottom: 6px; font-size: 13px; cursor: pointer; color: #bbb; }
        .filter-row:hover { color: #fff; }
        .f-icon { width: 20px; text-align: center; margin-right: 8px; }
        
        /* --- SMART COORDS BOX --- */
        .coord-box { 
            position: absolute; bottom: 20px; left: 20px; z-index: 1000; 
            background: #000; border: 1px solid #333; border-radius: 4px;
            display: flex; align-items: center; overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .coord-input {
            background: transparent; border: none; color: #00e676;
            font-family: monospace; font-size: 14px; font-weight: bold;
            padding: 8px 12px; width: 140px; outline: none;
        }
        .coord-input::placeholder { color: #00552b; }
        .coord-icon { padding-right: 8px; color: #444; font-size: 12px; cursor: pointer;}
        .coord-icon:hover { color: #fff; }

        /* --- √çCONES DIN√ÇMICOS & CONTRASTE --- */
        .map-icon { 
            text-align: center; 
            display: flex !important; align-items: center; justify-content: center;
            text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000, 0 0 5px #000;
            transition: font-size 0.2s ease, transform 0.2s;
        }

        /* ESCALA REDUZIDA (Discreto como vegeta√ß√£o) */
        .zoom-0 .map-icon { font-size: 6px !important; opacity: 0.6; }
        .zoom-1 .map-icon { font-size: 10px !important; opacity: 0.8; }
        .zoom-2 .map-icon { font-size: 12px !important; }
        .zoom-3 .map-icon { font-size: 16px !important; }
        .zoom-4 .map-icon { font-size: 20px !important; } /* Max size menor */

        .map-icon:hover { transform: scale(1.3) !important; opacity: 1 !important; z-index: 9999; cursor: pointer; }
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; color: #000; text-transform: uppercase; display: inline-block; margin-top: 3px; }

    </style>
</head>
<body>

    <div class="sidebar">
        <div class="glass-box brand-box">
            <h1 class="brand-title">HARMONY <span style="color:#00e676">SATVIEW</span></h1>
            <div class="brand-sub">Monitoring System</div>
        </div>
        <div class="glass-box">
            <button id="btnEditMode" class="edit-btn" onclick="toggleEditMode()">
                <span id="editIcon">‚úèÔ∏è</span> <span id="editText">View Mode</span>
            </button>
        </div>
        <div class="glass-box">
            <div style="font-weight:bold; font-size:10px; color:#666; margin-bottom:10px; text-transform:uppercase; letter-spacing:1px;">Layers</div>
            <label class="filter-row" style="color:#ffea00"><input type="checkbox" checked onchange="toggleGroup('deeds_active')"> <span class="f-icon">üèõÔ∏è</span> Active Deeds</label>
            <label class="filter-row" style="color:#ffffff"><input type="checkbox" checked onchange="toggleGroup('deeds_fallen')"> <span class="f-icon">üèöÔ∏è</span> History / Ruins</label>
            <label class="filter-row"><input type="checkbox" checked onchange="toggleGroup('rift')"> <span class="f-icon">üåÄ</span> Rifts</label>
            <div style="border-top:1px solid #333; margin:5px 0;"></div>
            <label class="filter-row" style="color:#00e676"><input type="checkbox" checked onchange="toggleGroup('botany')"> <span class="f-icon">üå≤</span> Botany (Flora)</label>
            <label class="filter-row" style="color:#ff5252"><input type="checkbox" checked onchange="toggleGroup('mobs')"> <span class="f-icon">üêæ</span> Fauna</label>
        </div>
        <div class="glass-box" style="padding:8px;">
             <button onclick="exportarDados()" style="width:100%; background:transparent; border:1px dashed #444; color:#666; padding:5px; cursor:pointer; font-size:10px; border-radius: 4px;">
                üíæ Export Data (JSON)
             </button>
        </div>
        <div class="credits-box">Dev by <span class="guild-name">A GUILDA</span><br>Harmony Server ‚Ä¢ 2025</div>
    </div>

    <!-- SMART COORDS INPUT -->
    <div class="coord-box">
        <input type="text" id="coordInput" class="coord-input" placeholder="X, Y (Enter)" autocomplete="off">
        <span class="coord-icon" onclick="focarInput()" title="Type coordinates">üìç</span>
    </div>

    <!-- MODAL -->
    <div id="modal">
        <div class="modal-header">
            <span>üìç Add Marker</span>
            <span style="cursor:pointer; color:#666" onclick="fecharModal()">‚úï</span>
        </div>
        <div class="form-group">
            <label class="form-label">Category</label>
            <select id="inputType" class="form-select" onchange="atualizarFormulario()">
                <option value="deed">üèõÔ∏è Active Deed</option>
                <option value="ruin">üèöÔ∏è History / Ruin</option>
                <option value="tree">üå≤ Tree (Sprout)</option>
                <option value="bush">üåø Bush (Seedling)</option>
                <option value="rift">üåÄ Rift</option>
                <option value="lair">üêæ Fauna / Lair</option>
                <option value="unique">üê≤ Unique / Boss</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label" id="nameLabel">Name / Type</label>
            <input type="text" id="inputName" class="form-input" placeholder="Ex: North Village">
            
            <select id="selectTree" class="form-select" style="display:none">
                <option value="Apple tree">Apple tree</option>
                <option value="Birch tree">Birch tree</option>
                <option value="Cedar tree">Cedar tree</option>
                <option value="Cherry tree">Cherry tree</option>
                <option value="Chestnut tree">Chestnut tree</option>
                <option value="Fir tree">Fir tree</option>
                <option value="Lemon tree">Lemon tree</option>
                <option value="Linden tree">Linden tree</option>
                <option value="Maple tree">Maple tree</option>
                <option value="Oak tree">Oak tree</option>
                <option value="Olive tree">Olive tree</option>
                <option value="Orange tree">Orange tree</option>
                <option value="Pine tree">Pine tree</option>
                <option value="Walnut tree">Walnut tree</option>
                <option value="Willow tree">Willow tree</option>
            </select>

            <select id="selectBush" class="form-select" style="display:none">
                <option value="Blueberry bush">Blueberry bush</option>
                <option value="Camellia bush">Camellia bush</option>
                <option value="Grape bush">Grape bush</option>
                <option value="Hazelnut bush">Hazelnut bush</option>
                <option value="Lavender bush">Lavender bush</option>
                <option value="Lingonberry bush">Lingonberry bush</option>
                <option value="Oleander bush">Oleander bush</option>
                <option value="Raspberry bush">Raspberry bush</option>
                <option value="Rose bush">Rose bush</option>
                <option value="Thorn bush">Thorn bush</option>
            </select>
        </div>
        <div class="form-group" id="rangeGroup" style="display:none">
            <div class="range-wrapper">
                <label class="form-label" style="margin-bottom:10px">Forest Range</label>
                <input type="range" id="inputRange" class="range-slider" min="1" max="5" step="1" value="1" oninput="atualizarRangeLabel(this.value)">
                <div class="range-value">Size: <span id="rangeLabel">1 (Small)</span></div>
            </div>
        </div>
        <div class="form-group">
            <label class="form-label">Description / Date</label>
            <input type="text" id="inputDesc" class="form-input" placeholder="Optional">
        </div>
        <div class="modal-actions">
            <button class="btn-cancel" onclick="fecharModal()">Cancel</button>
            <button class="btn-save" onclick="salvarPonto()">Save Marker</button>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const MAP_SIZE = 4096;
        const SCALE_FACTOR = 1/16; 

        L.CRS.Harmony = L.Util.extend({}, L.CRS.Simple, { transformation: new L.Transformation(SCALE_FACTOR, 0, SCALE_FACTOR, 0) });

        var map = L.map('map', {
            crs: L.CRS.Harmony, minZoom: 0, maxZoom: 4, zoomControl: false,
            maxBounds: [[0,0], [MAP_SIZE, MAP_SIZE]]
        });
        L.control.zoom({ position: 'topright' }).addTo(map);
        map.fitBounds([[0,0], [MAP_SIZE, MAP_SIZE]]);

        var layerTerreno = L.tileLayer('tiles_terreno/{z}/{x}/{y}.png', { minZoom: 0, maxZoom: 4, tileSize: 256, noWrap: true, tms: false, bounds: [[0,0], [MAP_SIZE, MAP_SIZE]] }).addTo(map);
        var layerTopo = L.tileLayer('tiles_topo/{z}/{x}/{y}.png', { minZoom: 0, maxZoom: 4, tileSize: 256, noWrap: true, tms: false, bounds: [[0,0], [MAP_SIZE, MAP_SIZE]] });

        var editMode = false;
        var tempClickCoords = { x: 0, y: 0 };
        var inputFocado = false; // Controla se o usu√°rio est√° digitando
        
        // --- CONFIGURA√á√ÉO DE CORES E √çCONES ---
        const config = {
            'deed':        { icon: 'üèõÔ∏è', color: '#ffea00', group: 'deeds_active', label: 'Active' }, // Amarelo Ouro
            'ruin':        { icon: 'üèöÔ∏è', color: '#ffffff', group: 'deeds_fallen', label: 'Ruin' },   // Branco Contraste
            'rift':        { icon: 'üåÄ', color: '#e040fb', group: 'rift', label: 'Rift' },
            'ore':         { icon: '‚õèÔ∏è', color: '#90a4ae', group: 'ores', label: 'Ore' }, 
            'tree':        { icon: 'üå≤', color: '#00e676', group: 'botany', label: 'Tree' },
            'bush':        { icon: 'üåø', color: '#76ff03', group: 'botany', label: 'Bush' },
            'lair':        { icon: 'üêæ', color: '#ff5252', group: 'mobs', label: 'Lair' },
            'unique':      { icon: 'üê≤', color: '#ff1744', group: 'mobs', label: 'Unique' }
        };

        var dados = []; // BANCO DE DADOS LIMPO
        var layers = L.layerGroup().addTo(map);
        var filtrosAtivos = { deeds_active: true, deeds_fallen: true, rift: true, ores: true, botany: true, mobs: true };
        var tempMarker = null; // Marcador tempor√°rio do "Go To"

        function renderizarMapa(busca = "") {
            layers.clearLayers();
            dados.forEach(d => {
                let conf = config[d.cat] || { icon: 'üìç', color: '#fff', group: 'outros' };
                if (!filtrosAtivos[conf.group]) return;
                let nome = d.nome || d.item;
                if (busca && !(nome + " " + (d.desc||"")).toLowerCase().includes(busca.toLowerCase())) return;

                if (d.escala) {
                    let radiuses = [20, 45, 70, 95, 120]; 
                    let raio = radiuses[d.escala - 1] || 20;
                    L.circle([d.y, d.x], { color: conf.color, fillColor: '#fff', fillOpacity: 0.15, opacity: 0.6, radius: raio, weight: 1, dashArray: '2, 4' }).addTo(layers);
                }

                let htmlIcon = `<div style="color:${conf.color};">${conf.icon}</div>`;
                
                L.marker([d.y, d.x], { 
                    icon: L.divIcon({ 
                        className: 'map-icon', 
                        html: htmlIcon, 
                        iconSize: [30, 30], iconAnchor: [15, 15] 
                    }) 
                })
                .bindPopup(`<div style="text-align:center; font-family:sans-serif; min-width:150px"><strong style="color:${conf.color}; font-size:14px">${conf.icon} ${nome}</strong><br><span class="badge" style="background:${conf.color}; margin: 5px 0; display:inline-block">${conf.label}</span><p style="margin:5px 0; font-size:12px; color:#ccc">${d.desc || ''}</p><div style="background:#222; color:#666; font-size:10px; padding:2px; border-radius:4px; margin-top:5px">X:${d.x} Y:${d.y}</div></div>`)
                .addTo(layers);
            });
        }

        // --- SMART COORDINATES LOGIC ---
        const coordInput = document.getElementById('coordInput');

        coordInput.addEventListener('focus', () => { inputFocado = true; });
        coordInput.addEventListener('blur', () => { inputFocado = false; });

        coordInput.addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                let val = this.value.trim();
                let x, y;

                // Caso 1: Sequ√™ncia de 8 n√∫meros (ex: 10242048)
                if (/^\d{8}$/.test(val)) {
                    x = parseInt(val.substring(0, 4));
                    y = parseInt(val.substring(4, 8));
                } 
                // Caso 2: Separado por espa√ßo, v√≠rgula ou ponto
                else {
                    // Substitui tudo que n√£o √© n√∫mero por espa√ßo e divide
                    let parts = val.replace(/[^0-9]/g, ' ').trim().split(/\s+/);
                    if (parts.length >= 2) {
                        x = parseInt(parts[0]);
                        y = parseInt(parts[1]);
                    }
                }

                // Executa o voo se achou coords v√°lidas
                if (!isNaN(x) && !isNaN(y)) {
                    // Trava nas bordas
                    x = Math.max(0, Math.min(x, MAP_SIZE));
                    y = Math.max(0, Math.min(y, MAP_SIZE));
                    
                    map.flyTo([y, x], 4); // Zoom m√°ximo
                    
                    // Marcador visual tempor√°rio (Pino vermelho)
                    if (tempMarker) map.removeLayer(tempMarker);
                    tempMarker = L.marker([y, x]).addTo(map).bindPopup(`üìç Go To: ${x}, ${y}`).openPopup();
                    
                    // Limpa o input (opcional, ou deixa pra ele ver onde foi)
                    this.blur(); 
                }
            }
        });

        function focarInput() { document.getElementById('coordInput').focus(); }

        // --- UI & EDITOR ---
        function toggleEditMode() {
            editMode = !editMode;
            const btn = document.getElementById('btnEditMode');
            const txt = document.getElementById('editText');
            if (editMode) {
                btn.classList.add('active');
                txt.innerText = "EDIT MODE ACTIVE";
                document.getElementById('map').style.cursor = "copy";
            } else {
                btn.classList.remove('active');
                txt.innerText = "View Mode";
                document.getElementById('map').style.cursor = "crosshair";
            }
        }

        map.on('click', function(e) {
            if (!editMode) return;
            tempClickCoords = { x: Math.round(e.latlng.lng), y: Math.round(e.latlng.lat) };
            document.getElementById('modal').style.display = 'block';
        });

        function fecharModal() { document.getElementById('modal').style.display = 'none'; }
        function atualizarFormulario() {
            const tipo = document.getElementById('inputType').value;
            document.getElementById('inputName').style.display = (tipo !== 'tree' && tipo !== 'bush') ? 'block' : 'none';
            document.getElementById('selectTree').style.display = (tipo === 'tree') ? 'block' : 'none';
            document.getElementById('selectBush').style.display = (tipo === 'bush') ? 'block' : 'none';
            document.getElementById('rangeGroup').style.display = (tipo === 'tree' || tipo === 'bush') ? 'block' : 'none';
        }
        function atualizarRangeLabel(val) {
            const labels = ["Small", "Medium", "Large", "Dense", "Massive"];
            document.getElementById('rangeLabel').innerText = `${val} (${labels[val-1]})`;
        }
        function salvarPonto() {
            const tipo = document.getElementById('inputType').value;
            let nome = (tipo === 'tree') ? document.getElementById('selectTree').value : (tipo === 'bush' ? document.getElementById('selectBush').value : document.getElementById('inputName').value);
            if (!nome) { alert("Name required!"); return; }
            const novoPonto = { cat: tipo, nome: nome, x: tempClickCoords.x, y: tempClickCoords.y, desc: document.getElementById('inputDesc').value, escala: (tipo === 'tree' || tipo === 'bush') ? parseInt(document.getElementById('inputRange').value) : null };
            dados.push(novoPonto);
            renderizarMapa();
            fecharModal();
            document.getElementById('inputName').value = ""; document.getElementById('inputDesc').value = "";
        }
        function exportarDados() { console.log(JSON.stringify(dados, null, 4)); alert("Data exported to Console (F12)!"); }
        function toggleGroup(grupo) { filtrosAtivos[grupo] = !filtrosAtivos[grupo]; renderizarMapa(document.querySelector('input[type="text"]').value); }
        function trocarMapa(tipo) { if (tipo === 'terreno') { map.addLayer(layerTerreno); map.removeLayer(layerTopo); } else { map.addLayer(layerTopo); map.removeLayer(layerTerreno); } }
        
        map.on('mousemove', e => {
            // S√≥ atualiza se o usu√°rio N√ÉO estiver digitando
            if (inputFocado) return;

            let x = Math.max(0, Math.min(Math.round(e.latlng.lng), MAP_SIZE));
            let y = Math.max(0, Math.min(Math.round(e.latlng.lat), MAP_SIZE));
            document.getElementById('coordInput').value = `${x}, ${y}`;
        });

        map.on('zoomend', function() {
            const z = map.getZoom();
            const mapDiv = document.getElementById('map');
            mapDiv.className = ""; 
            mapDiv.classList.add(`zoom-${z}`);
        });
        document.getElementById('map').classList.add(`zoom-${map.getZoom()}`);

        renderizarMapa();
    </script>
</body>
</html>